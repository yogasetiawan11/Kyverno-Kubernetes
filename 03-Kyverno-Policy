# Validate With Kyverno

Before we begin, refers to this documentation which contain bunch of example of kyverno usecase. [Click](https://github.com/kyverno/policies/tree/main/best-practices) 

Create a policy
```sh
kubectl apply -f https://raw.githubusercontent.com/kyverno/policies/refs/heads/main/best-practices/require-pod-requests-limits/require-pod-requests-limits.yaml
```
this command about Kyverno ``ClusterPolicy`` that checks every Pod creation and ensures:

1. Every Pod Must define resource requests and limits

For each container:
- resources.requests.cpu
- resources.requests.memory
- resources.limits.cpu
- resources.limits.memory
If any of these fields are missing, the Pod creation is DENIED.  

Once you've apply this policy, kubernetes admission controller will notice the policy.

- Check Kyverno controller
```sh
kubectl get pods -A | grep kyverno
```

After you have Installed kyverno policy, Kyverno controller will reading it and it will implement to all namespaces, you can also check trough the logs
- Check Logs of kyverno
```sh
kubectl get logs name-kyverno-pods -n kyverno
```

# Enforce the policy 
By default yaml file that available on the github's kyverno set up as ``Audit`` with this configuration sometimes the creation of the pods will be passed, to solve this you have to force by change the ``Audit`` to ``enforce``

```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-requests-limits
  annotations:
    policies.kyverno.io/title: Require Limits and Requests
    policies.kyverno.io/category: Best Practices, EKS Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/description: >-
      you can write an error massage here
spec:
  validationFailureAction: enforce #Audit
  background: true
  rules:
  - name: validate-resources
    match:
      any:
      - resources:
          kinds:
          - Pod
    validate:
      message: "CPU and memory resource requests and memory limits are required for containers."
      pattern:
        spec:
          containers:
          - resources:
              requests:
                memory: "?*"
                cpu: "?*"
              limits:
                memory: "?*"
          =(initContainers):
          - resources:
              requests:
                memory: "?*"
                cpu: "?*"
              limits:
                memory: "?*"
          =(ephemeralContainers):
          - resources:
              requests:
                memory: "?*"
                cpu: "?*"
              limits:
                memory: "?*"
```

## Edit The Policy 
1. Look for the ClusterPolicy
```sh
kubectl get ClusterPolicy
```
The output might be like this 
```sh
NAME                      BACKGROUND   VALIDATE ACTION   READY
require-requests-limits   true         audit             true
```
2. Then edit the ClusterPolicy
```sh
kubectl edit require-requests-limits
```
3. Test to create deployment/pods
```sh
k create deploy nginx --image=nginx
```
the output
```sh
error: failed to create deployment: admission webhook "validate.kyverno.svc-fail" denied the request: 

policy Deployment/default/nginx for resource violation: 

require-requests-limits:
  autogen-validate-resources: 'validation error: CPU and memory resource requests
    and memory limits are required for containers. rule autogen-validate-resources
    failed at path /spec/template/spec/containers/0/resources/limits/'
```
